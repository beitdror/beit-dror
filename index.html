<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>××¢×¨×›×ª ×œ×•×– ×“×™×’×™×˜×œ×™×ª - ×‘×™×ª ×“×¨×•×¨ğŸ³ï¸â€ğŸŒˆ</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-main: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --bg-card: #ffffff;
            --bg-fixed: #f0f4ff;
            --bg-hover: #f9fafb;
            --border: #e0e7ff;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --primary: #8b5cf6;
            --primary-hover: #7c3aed;
            --success: #10b981;
            --success-hover: #059669;
            --danger: #ef4444;
            --danger-hover: #dc2626;
            --warning: #f59e0b;
            --warning-bg: #fef3c7;
            --pending: #3b82f6;
            --pending-bg: #dbeafe;
            --approved: #10b981;
            --approved-bg: #d1fae5;
            --rejected: #ef4444;
            --rejected-bg: #fee2e2;
            --gradient-1: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --gradient-2: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --gradient-3: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            --gradient-4: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
            --gradient-5: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Heebo', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            background-attachment: fixed;
            color: var(--text-primary);
            line-height: 1.6;
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 32px;
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
            margin-bottom: 24px;
            text-align: center;
        }

        .header h1 {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 8px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .header p {
            color: rgba(255,255,255,0.9);
            font-size: 16px;
        }

        .tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
            background: white;
            padding: 12px;
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            overflow-x: auto;
        }

        .tab {
            padding: 12px 24px;
            background: transparent;
            border: 2px solid transparent;
            border-radius: 10px;
            cursor: pointer;
            font-family: 'Heebo', sans-serif;
            font-size: 15px;
            font-weight: 600;
            color: var(--text-secondary);
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .tab:hover {
            background: var(--bg-fixed);
            transform: translateY(-2px);
        }

        .tab.active {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            color: white;
            border-color: transparent;
            box-shadow: 0 4px 15px rgba(139, 92, 246, 0.3);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .card {
            background: var(--bg-card);
            padding: 28px;
            border-radius: 16px;
            border: none;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.15);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            font-size: 14px;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-family: 'Heebo', sans-serif;
            font-size: 14px;
            transition: border-color 0.2s;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--primary);
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            font-family: 'Heebo', sans-serif;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-primary {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            color: white;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%);
        }

        .btn-success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }

        .btn-success:hover {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
        }

        .btn-danger:hover {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
        }

        .btn-sm {
            padding: 8px 16px;
            font-size: 13px;
        }

        .schedule-container {
            overflow-x: auto;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            position: relative;
        }

        /* ×©×™×¤×•×¨ ×¢×‘×•×¨ ×˜×œ×¤×•×Ÿ - ×ª× ×’××™×© */
        @media (max-width: 768px) {
            .schedule-table td input {
                min-height: 60px;
                white-space: pre-wrap;
                word-wrap: break-word;
                height: auto !important;
            }
        }

        .schedule-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            background: white;
        }

        .schedule-table th,
        .schedule-table td {
            padding: 16px 12px;
            text-align: center;
            border: 1px solid var(--border);
        }

        .schedule-table th {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            color: white;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        /* ×¢××•×“×ª ×”×©×¢×•×ª ×ª×™×©××¨ ×§×‘×•×¢×” ×‘×¦×“ */
        .schedule-table th:first-child,
        .schedule-table td:first-child {
            position: sticky;
            right: 0;
            background: white;
            z-index: 5;
            font-weight: 600;
            box-shadow: 2px 0 4px rgba(0,0,0,0.05);
        }

        .schedule-table th:first-child {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            z-index: 15;
        }

        .schedule-table td input {
            width: 100%;
            padding: 10px;
            border: 1px solid #e0e7ff;
            border-radius: 6px;
            font-family: 'Heebo', sans-serif;
            text-align: center;
            transition: border-color 0.2s;
        }

        .schedule-table td input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
        }

        .schedule-table .fixed-time {
            background: #fee2e2;
            font-weight: 600;
            color: #dc2626;
            padding: 12px;
        }

        .schedule-table .suggested-time {
            background: #fef3c7;
            font-style: italic;
            color: #d97706;
            padding: 12px;
        }

        .submission-item {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 16px;
            border: 2px solid var(--border);
            transition: all 0.3s ease;
        }

        .submission-item:hover {
            box-shadow: 0 6px 20px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }

        .submission-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .submission-header h3 {
            margin: 0;
            font-size: 18px;
        }

        .status-badge {
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
        }

        .status-badge.pending {
            background: var(--pending-bg);
            color: var(--pending);
        }

        .status-badge.approved {
            background: var(--approved-bg);
            color: var(--approved);
        }

        .status-badge.rejected {
            background: var(--rejected-bg);
            color: var(--rejected);
        }

        .coordinator-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid var(--border);
        }

        .coordinator-item {
            background: #f9fafb;
            padding: 16px;
            border-radius: 10px;
            margin-bottom: 12px;
        }

        .coordinator-item h4 {
            margin-bottom: 8px;
            color: var(--primary);
        }

        .action-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 12px;
        }

        .toast {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            padding: 16px 28px;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(16, 185, 129, 0.4);
            z-index: 1000;
            transition: transform 0.3s ease;
            font-weight: 500;
            max-width: 90%;
            text-align: center;
        }

        .toast.show {
            transform: translateX(-50%) translateY(0);
        }

        .toast.danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            box-shadow: 0 10px 30px rgba(239, 68, 68, 0.4);
        }

        .legend {
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
            margin-bottom: 16px;
            padding: 16px;
            background: #f9fafb;
            border-radius: 10px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .legend-box {
            width: 24px;
            height: 24px;
            border-radius: 4px;
        }

        .legend-box.fixed {
            background: #fee2e2;
        }

        .legend-box.suggested {
            background: #fef3c7;
        }

        .legend-box.free {
            background: white;
            border: 1px solid var(--border);
        }

        .days-selector {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 12px;
        }

        .day-checkbox {
            display: flex;
            align-items: center;
            gap: 8px;
            background: #f9fafb;
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .day-checkbox:hover {
            background: #e0e7ff;
        }

        .day-checkbox input[type="checkbox"] {
            width: auto;
        }

        .structure-editor-item {
            background: #f9fafb;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 16px;
            border: 2px solid var(--border);
        }

        .structure-editor-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 16px;
        }

        @media (max-width: 768px) {
            .tabs {
                flex-wrap: nowrap;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            .structure-editor-controls {
                grid-template-columns: 1fr;
            }

            .legend {
                flex-direction: column;
            }

            .action-buttons {
                flex-direction: column;
            }

            .btn {
                width: 100%;
            }
        }

        /* ×›×¤×ª×•×¨ ×”×“×¤×¡×” */
        .print-btn {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
            margin-right: 8px;
        }

        .print-btn:hover {
            background: linear-gradient(135deg, #d97706 0%, #b45309 100%);
        }

        @media print {
            body {
                background: white;
                padding: 0;
            }

            .tabs, .header, .btn, .action-buttons, .coordinator-section {
                display: none !important;
            }

            .card {
                box-shadow: none;
                page-break-inside: avoid;
            }

            .schedule-table th:first-child,
            .schedule-table td:first-child {
                position: static;
            }
        }

        /* ×¡×’× ×•×Ÿ ×œ××¨×›×™×•×Ÿ */
        .archive-section {
            background: #fef3c7;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .archive-section h3 {
            color: #d97706;
            margin-bottom: 16px;
        }

        /* ×›×¤×ª×•×¨ ×™×™×¦×•× ×œ×™×•××Ÿ */
        .export-calendar-btn {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
        }

        .export-calendar-btn:hover {
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ³ï¸â€ğŸŒˆ ××¢×¨×›×ª ×œ×•×– ×“×™×’×™×˜×œ×™×ª - ×‘×™×ª ×“×¨×•×¨</h1>
            <p>× ×™×”×•×œ ×œ×•×–×™× ×©×‘×•×¢×™×™× ×‘×¦×•×¨×” ×§×œ×” ×•×™×¢×™×œ×”</p>
        </div>

        <div class="tabs">
            <button class="tab active" data-tab="student">×”×’×©×ª ×œ×•×– (× ×¢×¨/×”)</button>
            <button class="tab" data-tab="coordinator">× ×™×”×•×œ ×œ×•×–×™× (×¨×›×–×ª)</button>
            <button class="tab" data-tab="combined">×œ×•×– ×›×•×œ×œ</button>
            <button class="tab" data-tab="structure">×¢×¨×™×›×ª ××‘× ×” ×œ×•×–</button>
        </div>

        <!-- TAB: Student Submission -->
        <div class="tab-content active" id="studentTab">
            <div class="card">
                <h2 style="margin-bottom: 20px; color: var(--primary);">×”×’×©×ª ×œ×•×– ×©×‘×•×¢×™</h2>
                
                <div class="form-group">
                    <label>×©× ××œ×</label>
                    <input type="text" id="studentName" placeholder="×”×›× ×¡/×™ ××ª ×©××š ×”××œ×">
                </div>

                <div class="form-group">
                    <label>×‘×—×¨/×™ ×©×‘×•×¢</label>
                    <select id="weekSelect">
                        <!-- ×™×ª××œ× ×“×™× ××™×ª -->
                    </select>
                </div>

                <div class="legend">
                    <div class="legend-item">
                        <div class="legend-box free"></div>
                        <span>×©×¢×” ×—×•×¤×©×™×ª - ×ª××œ×/×™ ×œ×¤×™ ×¨×¦×•× ×š</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-box suggested"></div>
                        <span>×”× ×—×™×” - ××•×¦×¢ ×œ××œ× ×›×¤×™ ×”×”× ×—×™×”</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-box fixed"></div>
                        <span>×©×¢×” ×¡×’×•×¨×” - ×œ× × ×™×ª×Ÿ ×œ×©×™× ×•×™</span>
                    </div>
                </div>

                <div class="schedule-container" id="studentScheduleContainer">
                    <!-- ×™×ª××œ× ×“×™× ××™×ª -->
                </div>

                <button class="btn btn-primary" style="margin-top: 20px; width: 100%;" onclick="submitSchedule()">
                    âœ… ×©×œ×— ×œ×•×– ×œ××™×©×•×¨
                </button>
            </div>

            <!-- Previous Submissions -->
            <div class="card">
                <h3 style="margin-bottom: 16px; color: var(--primary);">×”×”×’×©×•×ª ×©×œ×™</h3>
                <div id="mySubmissions">
                    <!-- ×™×ª××œ× ×“×™× ××™×ª -->
                </div>
            </div>
        </div>

        <!-- TAB: Coordinator Management -->
        <div class="tab-content" id="coordinatorTab">
            <div class="card">
                <h2 style="margin-bottom: 20px; color: var(--primary);">× ×™×”×•×œ ×œ×•×–×™×</h2>
                
                <div class="form-group">
                    <label>×¡× ×Ÿ ×œ×¤×™ ×©×‘×•×¢</label>
                    <select id="coordinatorWeekFilter">
                        <option value="">×›×œ ×”×©×‘×•×¢×•×ª</option>
                        <!-- ×™×ª××œ× ×“×™× ××™×ª -->
                    </select>
                </div>

                <div class="form-group">
                    <label>×¡× ×Ÿ ×œ×¤×™ ×¡×˜×˜×•×¡</label>
                    <select id="coordinatorStatusFilter">
                        <option value="">×”×›×œ</option>
                        <option value="pending">×××ª×™×Ÿ ×œ××™×©×•×¨</option>
                        <option value="approved">×××•×©×¨</option>
                        <option value="rejected">× ×“×—×”</option>
                    </select>
                </div>

                <div id="coordinatorSubmissions">
                    <!-- ×™×ª××œ× ×“×™× ××™×ª -->
                </div>
            </div>

            <!-- ××¨×›×™×•×Ÿ -->
            <div class="card archive-section">
                <h3>ğŸ“¦ ××¨×›×™×•×Ÿ ×œ×•×–×™×</h3>
                <p style="margin-bottom: 16px; color: #92400e;">×œ×•×–×™× ×©×”×•×¢×‘×¨×• ×œ××¨×›×™×•×Ÿ</p>
                <div id="archiveList">
                    <!-- ×™×ª××œ× ×“×™× ××™×ª -->
                </div>
            </div>
        </div>

        <!-- TAB: Combined Schedule -->
        <div class="tab-content" id="combinedTab">
            <div class="card">
                <h2 style="margin-bottom: 20px; color: var(--primary);">×œ×•×– ×›×•×œ×œ ××©×•×œ×‘</h2>
                
                <div style="display: flex; gap: 12px; margin-bottom: 20px; flex-wrap: wrap;">
                    <div class="form-group" style="flex: 1; margin: 0;">
                        <label>×‘×—×¨ ×©×‘×•×¢</label>
                        <select id="combinedWeekSelect">
                            <!-- ×™×ª××œ× ×“×™× ××™×ª -->
                        </select>
                    </div>
                    
                    <button class="btn export-calendar-btn" onclick="exportToGoogleCalendar()" style="margin-top: auto;">
                        ğŸ“… ×™×™×¦× ×œ×™×•××Ÿ ×’×•×’×œ
                    </button>
                    
                    <button class="btn print-btn" onclick="printCombinedSchedule()" style="margin-top: auto;">
                        ğŸ–¨ï¸ ×”×“×¤×¡
                    </button>
                </div>

                <div id="combinedScheduleContainer">
                    <!-- ×™×ª××œ× ×“×™× ××™×ª -->
                </div>
            </div>
        </div>

        <!-- TAB: Structure Editor -->
        <div class="tab-content" id="structureTab">
            <div class="card">
                <h2 style="margin-bottom: 20px; color: var(--primary);">×¢×¨×™×›×ª ××‘× ×” ×”×œ×•×–</h2>
                
                <div style="margin-bottom: 24px; padding: 16px; background: #fef3c7; border-radius: 10px;">
                    <p style="margin: 0; color: #92400e;">
                        <strong>ğŸ’¡ ×”×¡×‘×¨:</strong> ×›××Ÿ × ×™×ª×Ÿ ×œ×”×’×“×™×¨ ××ª ×”××‘× ×” ×”×‘×¡×™×¡×™ ×©×œ ×”×œ×•×– - ×©×¢×•×ª, ×¡×•×’×™ ×©×¢×•×ª (×—×•×¤×©×™/××•×¦×¢/×¡×’×•×¨), ×•×ª×•×›×Ÿ ×§×‘×•×¢.
                    </p>
                </div>

                <div id="structureEditorContent">
                    <!-- ×™×ª××œ× ×“×™× ××™×ª -->
                </div>

                <div style="display: flex; gap: 12px; margin-top: 24px; flex-wrap: wrap;">
                    <button class="btn btn-primary" onclick="addNewTimeSlot()">â• ×”×•×¡×£ ×©×¢×” ×—×“×©×”</button>
                    <button class="btn btn-success" onclick="saveScheduleStructure()">ğŸ’¾ ×©××•×¨ ×©×™× ×•×™×™×</button>
                    <button class="btn btn-danger" onclick="resetToDefaultStructure()">ğŸ”„ ××¤×¡ ×œ××¦×‘ ×‘×¨×™×¨×ª ××—×“×œ</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast"></div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

    <script>
        // ==============================================
        // FIREBASE CONFIGURATION
        // ==============================================
        const firebaseConfig = {
            apiKey: "AIzaSyDsWP9XVA_e0RSB8OJ-BFWZ0YP4evLiDm4",
            authDomain: "beit-dror-weekly-schedule.firebaseapp.com",
            databaseURL: "https://beit-dror-weekly-schedule-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "beit-dror-weekly-schedule",
            storageBucket: "beit-dror-weekly-schedule.firebasestorage.app",
            messagingSenderId: "733993736798",
            appId: "1:733993736798:web:c8ac3e07a9ce5d7f38d2e1"
        };

        let firebaseInitialized = false;
        let db = null;

        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.database();
            firebaseInitialized = true;
            console.log('Firebase initialized successfully');
        } catch (error) {
            console.error('Firebase initialization error:', error);
            showToast('×©×’×™××” ×‘×—×™×‘×•×¨ ×œ-Firebase. ×—×œ×§ ××”×ª×›×•× ×•×ª ×¢×©×•×™×•×ª ×œ× ×œ×¢×‘×•×“.', 'danger');
        }

        // ==============================================
        // DEFAULT SCHEDULE STRUCTURE
        // ==============================================
        const defaultScheduleStructure = {
            days: ['×¨××©×•×Ÿ', '×©× ×™', '×©×œ×™×©×™', '×¨×‘×™×¢×™', '×—××™×©×™', '×©×™×©×™', '×©×‘×ª'],
            times: [
                { time: '07:00', type: 'fixed', content: '×”×©×›××”', days: [0,1,2,3,4] },
                { time: '07:30', type: 'fixed', content: '××¨×•×—×ª ×‘×•×§×¨', days: [0,1,2,3,4,5,6] },
                { time: '08:00', type: 'free' },
                { time: '09:00', type: 'suggested', content: '×œ×™××•×“×™× / ×¤×¢×™×œ×•×ª ×‘×•×§×¨', days: [0,1,2,3,4] },
                { time: '10:00', type: 'free' },
                { time: '11:00', type: 'free' },
                { time: '12:00', type: 'free' },
                { time: '13:00', type: 'fixed', content: '××¨×•×—×ª ×¦×”×¨×™×™×', days: [0,1,2,3,4,5,6] },
                { time: '14:00', type: 'free' },
                { time: '15:00', type: 'free' },
                { time: '16:00', type: 'free' },
                { time: '17:00', type: 'free' },
                { time: '18:00', type: 'free' },
                { time: '19:00', type: 'fixed', content: '××¨×•×—×ª ×¢×¨×‘', days: [0,1,2,3,4,5,6] },
                { time: '20:00', type: 'free' },
                { time: '21:00', type: 'free' },
                { time: '22:00', type: 'suggested', content: '×”×›× ×” ×œ×©×™× ×”', days: [0,1,2,3,4] },
                { time: '23:00', type: 'fixed', content: '×©×™× ×”', days: [0,1,2,3,4] }
            ]
        };

        let scheduleStructure = JSON.parse(JSON.stringify(defaultScheduleStructure));

        // ==============================================
        // GLOBAL STATE
        // ==============================================
        let currentStudentSchedule = {};
        let allSubmissions = [];
        let archivedSubmissions = [];

        // 15 ×¦×‘×¢×™× ×©×•× ×™× ×œ×©××•×ª ×‘×œ×•×– ×”×›×•×œ×œ
        const nameColors = [
            '#FF6B6B', '#4ECDC4', '#45B7D1', '#FFA07A', '#98D8C8',
            '#F7DC6F', '#BB8FCE', '#85C1E2', '#F8B739', '#52B788',
            '#E63946', '#457B9D', '#F77F00', '#06FFA5', '#9D4EDD',
        ];
        let nameColorMap = {};

        // ==============================================
        // INITIALIZATION
        // ==============================================
        async function initializeApp() {
            setupTabs();
            await loadScheduleStructure();
            generateWeekOptions();
            renderStudentSchedule();
            await loadSubmissions();
            await loadArchivedSubmissions();
            renderCoordinatorView();
            renderCombinedSchedule();
            renderStructureEditor();
        }

        async function loadScheduleStructure() {
            if (!firebaseInitialized) {
                scheduleStructure = JSON.parse(JSON.stringify(defaultScheduleStructure));
                return;
            }

            try {
                const snapshot = await db.ref('scheduleStructure').once('value');
                const data = snapshot.val();
                
                if (data) {
                    scheduleStructure = data;
                } else {
                    scheduleStructure = JSON.parse(JSON.stringify(defaultScheduleStructure));
                    await db.ref('scheduleStructure').set(scheduleStructure);
                }
            } catch (error) {
                console.error('Error loading structure:', error);
                scheduleStructure = JSON.parse(JSON.stringify(defaultScheduleStructure));
            }
        }

        async function loadSubmissions() {
            if (!firebaseInitialized) {
                allSubmissions = [];
                return;
            }

            try {
                const snapshot = await db.ref('submissions').once('value');
                const data = snapshot.val();
                allSubmissions = data ? Object.entries(data).map(([id, sub]) => ({...sub, id})) : [];
                
                renderMySubmissions();
                renderCoordinatorView();
            } catch (error) {
                console.error('Error loading submissions:', error);
            }
        }

        async function loadArchivedSubmissions() {
            if (!firebaseInitialized) {
                archivedSubmissions = [];
                return;
            }

            try {
                const snapshot = await db.ref('archived').once('value');
                const data = snapshot.val();
                archivedSubmissions = data ? Object.entries(data).map(([id, sub]) => ({...sub, id})) : [];
                
                renderArchiveList();
            } catch (error) {
                console.error('Error loading archived submissions:', error);
            }
        }

        // ==============================================
        // TAB MANAGEMENT
        // ==============================================
        function setupTabs() {
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    const targetTab = tab.dataset.tab;
                    
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    
                    tab.classList.add('active');
                    document.getElementById(targetTab + 'Tab').classList.add('active');
                });
            });
        }

        // ==============================================
        // WEEK GENERATION
        // ==============================================
        function generateWeekOptions() {
            const selects = [
                document.getElementById('weekSelect'),
                document.getElementById('coordinatorWeekFilter'),
                document.getElementById('combinedWeekSelect')
            ];

            const weeks = [];
            const today = new Date();
            
            // ×™×¦×™×¨×ª 8 ×©×‘×•×¢×•×ª ×§×“×™××”
            for (let i = 0; i < 8; i++) {
                const weekStart = new Date(today);
                weekStart.setDate(today.getDate() + (i * 7) - today.getDay());
                
                const weekEnd = new Date(weekStart);
                weekEnd.setDate(weekStart.getDate() + 6);
                
                const formatDate = (d) => `${d.getDate().toString().padStart(2, '0')}/${(d.getMonth() + 1).toString().padStart(2, '0')}`;
                
                weeks.push({
                    value: `${weekStart.getFullYear()}-W${i}`,
                    label: `${formatDate(weekStart)} - ${formatDate(weekEnd)}`,
                    date: weekStart.getTime()
                });
            }

            // ××™×•×Ÿ ××”×§×¨×•×‘ ×œ×¨×—×•×§
            weeks.sort((a, b) => a.date - b.date);

            selects.forEach(select => {
                if (!select) return;
                
                select.innerHTML = '';
                
                if (select.id === 'coordinatorWeekFilter') {
                    const allOption = document.createElement('option');
                    allOption.value = '';
                    allOption.textContent = '×›×œ ×”×©×‘×•×¢×•×ª';
                    select.appendChild(allOption);
                }
                
                weeks.forEach(week => {
                    const option = document.createElement('option');
                    option.value = week.value;
                    option.textContent = week.label;
                    select.appendChild(option);
                });
                
                // ×‘×—×™×¨×ª ×”×©×‘×•×¢ ×”× ×•×›×—×™
                if (select.id !== 'coordinatorWeekFilter') {
                    select.value = weeks[0].value;
                }
            });
        }

        // ==============================================
        // STUDENT SCHEDULE RENDERING
        // ==============================================
        function renderStudentSchedule() {
            const container = document.getElementById('studentScheduleContainer');
            let html = '<table class="schedule-table"><thead><tr><th>×©×¢×”</th>';
            
            scheduleStructure.days.forEach(day => {
                html += `<th>${day}</th>`;
            });
            
            html += '</tr></thead><tbody>';
            
            scheduleStructure.times.forEach(timeSlot => {
                html += `<tr><td>${timeSlot.time}</td>`;
                
                scheduleStructure.days.forEach((day, dayIndex) => {
                    const isFixed = timeSlot.type === 'fixed' && timeSlot.days && timeSlot.days.includes(dayIndex);
                    const isSuggested = timeSlot.type === 'suggested' && timeSlot.days && timeSlot.days.includes(dayIndex);
                    
                    if (isFixed) {
                        html += `<td class="fixed-time">${timeSlot.content}</td>`;
                    } else if (isSuggested) {
                        const placeholder = timeSlot.content || '';
                        const key = `${timeSlot.time}-${dayIndex}`;
                        const value = currentStudentSchedule[key] || '';
                        html += `<td class="suggested-time">
                            <input type="text" 
                                   placeholder="${placeholder}"
                                   value="${value}"
                                   onchange="updateStudentSchedule('${key}', this.value)">
                        </td>`;
                    } else {
                        const key = `${timeSlot.time}-${dayIndex}`;
                        const value = currentStudentSchedule[key] || '';
                        html += `<td>
                            <input type="text" 
                                   value="${value}"
                                   onchange="updateStudentSchedule('${key}', this.value)">
                        </td>`;
                    }
                });
                
                html += '</tr>';
            });
            
            html += '</tbody></table>';
            container.innerHTML = html;
        }

        function updateStudentSchedule(key, value) {
            currentStudentSchedule[key] = value;
        }

        async function submitSchedule() {
            const name = document.getElementById('studentName').value.trim();
            const week = document.getElementById('weekSelect').value;

            if (!name) {
                showToast('× × ×œ×”×–×™×Ÿ ×©×', 'danger');
                return;
            }

            if (!firebaseInitialized) {
                showToast('×œ× × ×™×ª×Ÿ ×œ×©×œ×•×— - Firebase ×œ× ××—×•×‘×¨', 'danger');
                return;
            }

            const submission = {
                studentName: name,
                week: week,
                schedule: currentStudentSchedule,
                status: 'pending',
                submittedAt: Date.now()
            };

            try {
                await db.ref('submissions').push(submission);
                showToast('×”×œ×•×– × ×©×œ×— ×‘×”×¦×œ×—×”! âœ…');
                
                currentStudentSchedule = {};
                renderStudentSchedule();
                document.getElementById('studentName').value = '';
                
                await loadSubmissions();
            } catch (error) {
                console.error('Error submitting:', error);
                showToast('×©×’×™××” ×‘×©×œ×™×—×”', 'danger');
            }
        }

        // ==============================================
        // MY SUBMISSIONS
        // ==============================================
        function renderMySubmissions() {
            const container = document.getElementById('mySubmissions');
            const name = document.getElementById('studentName').value.trim();
            
            if (!name) {
                container.innerHTML = '<p style="color: var(--text-secondary);">×”×–×Ÿ ××ª ×©××š ×›×“×™ ×œ×¨××•×ª ××ª ×”×”×’×©×•×ª ×©×œ×š</p>';
                return;
            }

            const mySubmissions = allSubmissions.filter(s => s.studentName === name);
            
            if (mySubmissions.length === 0) {
                container.innerHTML = '<p style="color: var(--text-secondary);">××™×Ÿ ×”×’×©×•×ª ×¢×“×™×™×Ÿ</p>';
                return;
            }

            let html = '';
            mySubmissions.forEach(sub => {
                html += `
                    <div class="submission-item">
                        <div class="submission-header">
                            <h3>×©×‘×•×¢ ${sub.week}</h3>
                            <span class="status-badge ${sub.status}">${getStatusText(sub.status)}</span>
                        </div>
                        <p style="color: var(--text-secondary); font-size: 14px;">
                            × ×©×œ×—: ${new Date(sub.submittedAt).toLocaleString('he-IL')}
                        </p>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function getStatusText(status) {
            const texts = {
                pending: '×××ª×™×Ÿ ×œ××™×©×•×¨',
                approved: '×××•×©×¨ âœ“',
                rejected: '× ×“×—×”'
            };
            return texts[status] || status;
        }

        // ==============================================
        // COORDINATOR VIEW
        // ==============================================
        function renderCoordinatorView() {
            const container = document.getElementById('coordinatorSubmissions');
            const weekFilter = document.getElementById('coordinatorWeekFilter').value;
            const statusFilter = document.getElementById('coordinatorStatusFilter').value;

            let filtered = allSubmissions;
            
            if (weekFilter) {
                filtered = filtered.filter(s => s.week === weekFilter);
            }
            
            if (statusFilter) {
                filtered = filtered.filter(s => s.status === statusFilter);
            }

            if (filtered.length === 0) {
                container.innerHTML = '<p style="color: var(--text-secondary);">××™×Ÿ ×”×’×©×•×ª ×œ×”×¦×’×”</p>';
                return;
            }

            let html = '';
            filtered.forEach(sub => {
                html += `
                    <div class="submission-item">
                        <div class="submission-header">
                            <div>
                                <h3>${sub.studentName}</h3>
                                <p style="color: var(--text-secondary); margin: 4px 0 0 0;">×©×‘×•×¢ ${sub.week}</p>
                            </div>
                            <span class="status-badge ${sub.status}">${getStatusText(sub.status)}</span>
                        </div>
                        
                        <div class="coordinator-section">
                            <h4>×œ×•×– ×©×”×•×’×©:</h4>
                            ${renderMiniSchedule(sub.schedule)}
                        </div>

                        <div class="action-buttons">
                            ${sub.status === 'pending' ? `
                                <button class="btn btn-success btn-sm" onclick="approveSubmission('${sub.id}')">âœ… ××©×¨</button>
                                <button class="btn btn-danger btn-sm" onclick="rejectSubmission('${sub.id}')">âŒ ×“×—×”</button>
                            ` : ''}
                            <button class="btn print-btn btn-sm" onclick="printIndividualSchedule('${sub.id}')">ğŸ–¨ï¸ ×”×“×¤×¡</button>
                            <button class="btn btn-danger btn-sm" onclick="archiveSubmission('${sub.id}')">ğŸ“¦ ×”×¢×‘×¨ ×œ××¨×›×™×•×Ÿ</button>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function renderMiniSchedule(schedule) {
            let html = '<div style="overflow-x: auto; margin-top: 12px;"><table class="schedule-table" style="font-size: 12px;"><thead><tr><th>×©×¢×”</th>';
            
            scheduleStructure.days.forEach(day => {
                html += `<th>${day}</th>`;
            });
            
            html += '</tr></thead><tbody>';
            
            scheduleStructure.times.forEach(timeSlot => {
                html += `<tr><td>${timeSlot.time}</td>`;
                
                scheduleStructure.days.forEach((day, dayIndex) => {
                    const key = `${timeSlot.time}-${dayIndex}`;
                    const value = schedule[key] || '-';
                    const isFixed = timeSlot.type === 'fixed' && timeSlot.days && timeSlot.days.includes(dayIndex);
                    
                    if (isFixed) {
                        html += `<td class="fixed-time" style="padding: 8px;">${timeSlot.content}</td>`;
                    } else {
                        html += `<td style="padding: 8px;">${value}</td>`;
                    }
                });
                
                html += '</tr>';
            });
            
            html += '</tbody></table></div>';
            return html;
        }

        async function approveSubmission(id) {
            if (!firebaseInitialized) return;
            
            try {
                await db.ref(`submissions/${id}/status`).set('approved');
                showToast('×”×œ×•×– ××•×©×¨! âœ…');
                await loadSubmissions();
                renderCombinedSchedule();
            } catch (error) {
                console.error('Error approving:', error);
                showToast('×©×’×™××” ×‘××™×©×•×¨', 'danger');
            }
        }

        async function rejectSubmission(id) {
            if (!firebaseInitialized) return;
            
            const reason = prompt('×¡×™×‘×ª ×“×—×™×™×” (××•×¤×¦×™×•× ×œ×™):');
            
            try {
                await db.ref(`submissions/${id}`).update({
                    status: 'rejected',
                    rejectionReason: reason || ''
                });
                showToast('×”×œ×•×– × ×“×—×”');
                await loadSubmissions();
            } catch (error) {
                console.error('Error rejecting:', error);
                showToast('×©×’×™××” ×‘×“×—×™×™×”', 'danger');
            }
        }

        async function archiveSubmission(id) {
            if (!confirm('×”×× ×œ×”×¢×‘×™×¨ ×œ×•×– ×–×” ×œ××¨×›×™×•×Ÿ?')) return;
            if (!firebaseInitialized) return;

            try {
                const submission = allSubmissions.find(s => s.id === id);
                if (!submission) return;

                // ×”×¢×‘×¨×” ×œ××¨×›×™×•×Ÿ
                await db.ref(`archived/${id}`).set({
                    ...submission,
                    archivedAt: Date.now()
                });

                // ××—×™×§×” ××”×¨×©×™××” ×”×¨××©×™×ª
                await db.ref(`submissions/${id}`).remove();

                showToast('×”×œ×•×– ×”×•×¢×‘×¨ ×œ××¨×›×™×•×Ÿ ğŸ“¦');
                await loadSubmissions();
                await loadArchivedSubmissions();
            } catch (error) {
                console.error('Error archiving:', error);
                showToast('×©×’×™××” ×‘×”×¢×‘×¨×” ×œ××¨×›×™×•×Ÿ', 'danger');
            }
        }

        function renderArchiveList() {
            const container = document.getElementById('archiveList');
            
            if (archivedSubmissions.length === 0) {
                container.innerHTML = '<p style="color: #92400e;">××™×Ÿ ×œ×•×–×™× ×‘××¨×›×™×•×Ÿ</p>';
                return;
            }

            let html = '';
            archivedSubmissions.forEach(sub => {
                html += `
                    <div class="submission-item" style="background: #fffbeb;">
                        <div class="submission-header">
                            <div>
                                <h3>${sub.studentName}</h3>
                                <p style="color: var(--text-secondary); margin: 4px 0 0 0;">
                                    ×©×‘×•×¢ ${sub.week} | ${getStatusText(sub.status)}
                                </p>
                            </div>
                        </div>
                        <p style="color: #92400e; font-size: 13px; margin-top: 8px;">
                            ×”×•×¢×‘×¨ ×œ××¨×›×™×•×Ÿ: ${new Date(sub.archivedAt).toLocaleString('he-IL')}
                        </p>
                        <div class="action-buttons">
                            <button class="btn btn-sm btn-primary" onclick="restoreFromArchive('${sub.id}')">â†©ï¸ ×©×—×–×¨</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteFromArchive('${sub.id}')">ğŸ—‘ï¸ ××—×§ ×œ×¦××™×ª×•×ª</button>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        async function restoreFromArchive(id) {
            if (!confirm('×”×× ×œ×©×—×–×¨ ×œ×•×– ×–×” ××”××¨×›×™×•×Ÿ?')) return;
            if (!firebaseInitialized) return;

            try {
                const submission = archivedSubmissions.find(s => s.id === id);
                if (!submission) return;

                // ×”×¡×¨×ª ×©×“×” archivedAt
                const { archivedAt, ...subData } = submission;

                // ×©×—×–×•×¨ ×œ×¨×©×™××” ×”×¨××©×™×ª
                await db.ref(`submissions/${id}`).set(subData);

                // ××—×™×§×” ××”××¨×›×™×•×Ÿ
                await db.ref(`archived/${id}`).remove();

                showToast('×”×œ×•×– ×©×•×—×–×¨ ×‘×”×¦×œ×—×” â†©ï¸');
                await loadSubmissions();
                await loadArchivedSubmissions();
            } catch (error) {
                console.error('Error restoring:', error);
                showToast('×©×’×™××” ×‘×©×—×–×•×¨', 'danger');
            }
        }

        async function deleteFromArchive(id) {
            if (!confirm('×”×× ×œ××—×•×§ ×œ×•×– ×–×” ×œ×¦××™×ª×•×ª? ×¤×¢×•×œ×” ×–×• ××™× ×” ×”×¤×™×›×”!')) return;
            if (!firebaseInitialized) return;

            try {
                await db.ref(`archived/${id}`).remove();
                showToast('×”×œ×•×– × ××—×§ ×œ×¦××™×ª×•×ª ğŸ—‘ï¸');
                await loadArchivedSubmissions();
            } catch (error) {
                console.error('Error deleting:', error);
                showToast('×©×’×™××” ×‘××—×™×§×”', 'danger');
            }
        }

        // ==============================================
        // COMBINED SCHEDULE
        // ==============================================
        function renderCombinedSchedule() {
            const container = document.getElementById('combinedScheduleContainer');
            const selectedWeek = document.getElementById('combinedWeekSelect').value;

            const approved = allSubmissions.filter(s => s.week === selectedWeek && s.status === 'approved');

            if (approved.length === 0) {
                container.innerHTML = '<p style="color: var(--text-secondary);">××™×Ÿ ×œ×•×–×™× ×××•×©×¨×™× ×œ×©×‘×•×¢ ×–×”</p>';
                return;
            }

            // ×”×§×¦××ª ×¦×‘×¢×™× ×œ×©××•×ª
            nameColorMap = {};
            approved.forEach((sub, index) => {
                nameColorMap[sub.studentName] = nameColors[index % nameColors.length];
            });

            let html = '<div style="overflow-x: auto;"><table class="schedule-table"><thead><tr><th>×©×¢×”</th>';
            
            scheduleStructure.days.forEach(day => {
                html += `<th>${day}</th>`;
            });
            
            html += '</tr></thead><tbody>';
            
            scheduleStructure.times.forEach(timeSlot => {
                html += `<tr><td>${timeSlot.time}</td>`;
                
                scheduleStructure.days.forEach((day, dayIndex) => {
                    const key = `${timeSlot.time}-${dayIndex}`;
                    const isFixed = timeSlot.type === 'fixed' && timeSlot.days && timeSlot.days.includes(dayIndex);
                    
                    if (isFixed) {
                        html += `<td class="fixed-time">${timeSlot.content}</td>`;
                    } else {
                        const entries = approved.map(sub => {
                            const value = sub.schedule[key];
                            if (value) {
                                const color = nameColorMap[sub.studentName];
                                return `<span style="color: ${color}; font-weight: 600;">${sub.studentName}:</span> ${value}`;
                            }
                            return null;
                        }).filter(Boolean);
                        
                        html += `<td style="text-align: right; padding: 12px; line-height: 1.8;">
                            ${entries.length > 0 ? entries.join('<br>') : '-'}
                        </td>`;
                    }
                });
                
                html += '</tr>';
            });
            
            html += '</tbody></table></div>';
            container.innerHTML = html;
        }

        function printCombinedSchedule() {
            window.print();
        }

        function printIndividualSchedule(id) {
            const submission = allSubmissions.find(s => s.id === id);
            if (!submission) return;

            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html dir="rtl">
                <head>
                    <meta charset="UTF-8">
                    <title>×œ×•×– - ${submission.studentName}</title>
                    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;600;700&display=swap" rel="stylesheet">
                    <style>
                        body { font-family: 'Heebo', sans-serif; padding: 20px; }
                        h1 { text-align: center; color: #8b5cf6; }
                        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                        th, td { border: 1px solid #ddd; padding: 12px; text-align: center; }
                        th { background: #8b5cf6; color: white; }
                        .fixed-time { background: #fee2e2; font-weight: 600; color: #dc2626; }
                    </style>
                </head>
                <body>
                    <h1>×œ×•×– ×©×‘×•×¢×™ - ${submission.studentName}</h1>
                    <h3 style="text-align: center;">×©×‘×•×¢ ${submission.week}</h3>
                    ${renderMiniSchedule(submission.schedule)}
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }

        // ==============================================
        // EXPORT TO GOOGLE CALENDAR
        // ==============================================
        function exportToGoogleCalendar() {
            const selectedWeek = document.getElementById('combinedWeekSelect').value;
            const approved = allSubmissions.filter(s => s.week === selectedWeek && s.status === 'approved');

            if (approved.length === 0) {
                showToast('××™×Ÿ ×œ×•×–×™× ×××•×©×¨×™× ×œ×™×™×¦×•×', 'danger');
                return;
            }

            // ×—×™×œ×•×¥ ×ª××¨×™×š ×”×ª×—×œ×” ××”×©×‘×•×¢
            const weekMatch = selectedWeek.match(/(\d{4})-W(\d+)/);
            if (!weekMatch) {
                showToast('×¤×•×¨××˜ ×©×‘×•×¢ ×œ× ×ª×§×™×Ÿ', 'danger');
                return;
            }

            const year = parseInt(weekMatch[1]);
            const weekNum = parseInt(weekMatch[2]);
            
            // ×—×™×©×•×‘ ×ª××¨×™×š ×”×ª×—×œ×” ×©×œ ×”×©×‘×•×¢
            const jan1 = new Date(year, 0, 1);
            const daysOffset = (weekNum * 7);
            const weekStart = new Date(jan1);
            weekStart.setDate(jan1.getDate() + daysOffset - jan1.getDay());

            // ×™×¦×™×¨×ª ×§×•×‘×¥ ICS
            let icsContent = `BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//Beit Dror//Weekly Schedule//HE
CALSCALE:GREGORIAN
METHOD:PUBLISH
X-WR-CALNAME:×œ×•×– ×©×‘×•×¢×™ - ×‘×™×ª ×“×¨×•×¨
X-WR-TIMEZONE:Asia/Jerusalem
X-WR-CALDESC:×œ×•×– ×©×‘×•×¢×™ ××©×•×œ×‘ - ${selectedWeek}
`;

            approved.forEach(submission => {
                scheduleStructure.times.forEach(timeSlot => {
                    scheduleStructure.days.forEach((day, dayIndex) => {
                        const key = `${timeSlot.time}-${dayIndex}`;
                        const activity = submission.schedule[key];
                        
                        if (activity && activity.trim()) {
                            const eventDate = new Date(weekStart);
                            eventDate.setDate(weekStart.getDate() + dayIndex);
                            
                            const [hours, minutes] = timeSlot.time.split(':');
                            eventDate.setHours(parseInt(hours), parseInt(minutes), 0);
                            
                            const endDate = new Date(eventDate);
                            endDate.setHours(eventDate.getHours() + 1);
                            
                            const formatICSDate = (date) => {
                                return date.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
                            };
                            
                            icsContent += `BEGIN:VEVENT
UID:${Date.now()}-${Math.random().toString(36).substr(2, 9)}@beitdror.com
DTSTAMP:${formatICSDate(new Date())}
DTSTART:${formatICSDate(eventDate)}
DTEND:${formatICSDate(endDate)}
SUMMARY:${activity} (${submission.studentName})
DESCRIPTION:${submission.studentName}: ${activity}
LOCATION:×‘×™×ª ×“×¨×•×¨
STATUS:CONFIRMED
TRANSP:OPAQUE
END:VEVENT
`;
                        }
                    });
                });
            });

            icsContent += 'END:VCALENDAR';

            // ×”×•×¨×“×ª ×”×§×•×‘×¥
            const blob = new Blob([icsContent], { type: 'text/calendar;charset=utf-8' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `×œ×•×–_×©×‘×•×¢×™_${selectedWeek}.ics`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            showToast('×§×•×‘×¥ ×™×•××Ÿ ×”×•×¨×“ ×‘×”×¦×œ×—×”! ğŸ“… × ×™×ª×Ÿ ×œ×™×™×‘× ××•×ª×• ×œ×™×•××Ÿ ×’×•×’×œ');
        }

        // ==============================================
        // STRUCTURE EDITOR
        // ==============================================
        function renderStructureEditor() {
            const container = document.getElementById('structureEditorContent');
            let html = '';

            scheduleStructure.times.forEach((timeSlot, index) => {
                html += `
                    <div class="structure-editor-item" data-index="${index}">
                        <div class="structure-editor-controls">
                            <div class="form-group" style="margin: 0;">
                                <label>×©×¢×”</label>
                                <input type="time" value="${timeSlot.time}" 
                                       onchange="updateTimeSlot(${index}, 'time', this.value)">
                            </div>
                            
                            <div class="form-group" style="margin: 0;">
                                <label>×¡×•×’</label>
                                <select onchange="updateTimeSlot(${index}, 'type', this.value)">
                                    <option value="free" ${timeSlot.type === 'free' ? 'selected' : ''}>×—×•×¤×©×™</option>
                                    <option value="suggested" ${timeSlot.type === 'suggested' ? 'selected' : ''}>××•×¦×¢ (×¢× ×”× ×—×™×”)</option>
                                    <option value="fixed" ${timeSlot.type === 'fixed' ? 'selected' : ''}>×¡×’×•×¨ (×—×•×‘×”)</option>
                                </select>
                            </div>
                        </div>
                        
                        ${timeSlot.type === 'fixed' ? `
                            <div class="form-group">
                                <label>×ª×•×›×Ÿ (×—×•×‘×” - ×œ× × ×™×ª×Ÿ ×œ×©×™× ×•×™)</label>
                                <input type="text" value="${timeSlot.content || ''}" 
                                       onchange="updateTimeSlot(${index}, 'content', this.value)"
                                       style="border-color: #dc2626;">
                            </div>
                            
                            <div class="form-group">
                                <label>×™××™×</label>
                                <div class="days-selector">
                                    ${scheduleStructure.days.map((day, dayIndex) => `
                                        <div class="day-checkbox">
                                            <input type="checkbox" 
                                                   id="day-${index}-${dayIndex}"
                                                   ${timeSlot.days && timeSlot.days.includes(dayIndex) ? 'checked' : ''}
                                                   onchange="updateTimeSlotDays(${index})">
                                            <label for="day-${index}-${dayIndex}">${day}</label>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        ` : timeSlot.type === 'suggested' ? `
                            <div class="form-group">
                                <label>×˜×§×¡×˜ ×”× ×—×™×” (××” ×”× ×¢×¨/×” ×××•×¨×™× ×œ×›×ª×•×‘)</label>
                                <input type="text" value="${timeSlot.content || ''}" 
                                       onchange="updateTimeSlot(${index}, 'content', this.value)"
                                       placeholder="×œ×“×•×’××”: ×œ×™××•×“×™× / ×¤×¢×™×œ×•×ª ×‘×•×§×¨"
                                       style="border-color: #f39c12;">
                            </div>
                            
                            <div class="form-group">
                                <label>×™××™×</label>
                                <div class="days-selector">
                                    ${scheduleStructure.days.map((day, dayIndex) => `
                                        <div class="day-checkbox">
                                            <input type="checkbox" 
                                                   id="day-${index}-${dayIndex}"
                                                   ${timeSlot.days && timeSlot.days.includes(dayIndex) ? 'checked' : ''}
                                                   onchange="updateTimeSlotDays(${index})">
                                            <label for="day-${index}-${dayIndex}">${day}</label>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}
                        
                        <button class="btn btn-danger btn-sm" onclick="deleteTimeSlot(${index})">ğŸ—‘ï¸ ××—×§ ×©×¢×”</button>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function updateTimeSlot(index, field, value) {
            if (field === 'type') {
                scheduleStructure.times[index].type = value;
                if (value === 'fixed' || value === 'suggested') {
                    scheduleStructure.times[index].content = scheduleStructure.times[index].content || '';
                    scheduleStructure.times[index].days = scheduleStructure.times[index].days || [];
                } else {
                    delete scheduleStructure.times[index].content;
                    delete scheduleStructure.times[index].days;
                }
                renderStructureEditor();
            } else {
                scheduleStructure.times[index][field] = value;
            }
        }

        function updateTimeSlotDays(index) {
            const days = [];
            scheduleStructure.days.forEach((day, dayIndex) => {
                const checkbox = document.getElementById(`day-${index}-${dayIndex}`);
                if (checkbox && checkbox.checked) {
                    days.push(dayIndex);
                }
            });
            scheduleStructure.times[index].days = days;
        }

        function deleteTimeSlot(index) {
            if (!confirm('×”×× ×œ××—×•×§ ××ª ×”×©×¢×”?')) return;
            scheduleStructure.times.splice(index, 1);
            renderStructureEditor();
        }

        function addNewTimeSlot() {
            const timeInput = prompt('×”×›× ×¡ ×©×¢×” ×—×“×©×” (×¤×•×¨××˜: HH:MM, ×œ×“×•×’××” 13:30):');
            
            if (!timeInput) return;
            
            const timeRegex = /^([0-1]?[0-9]|2[0-3]):([0-5][0-9])$/;
            if (!timeRegex.test(timeInput)) {
                showToast('×¤×•×¨××˜ ×©×¢×” ×œ× ×ª×§×™×Ÿ. ×”×©×ª××© ×‘-HH:MM (×œ××©×œ 13:30)', 'danger');
                return;
            }
            
            const exists = scheduleStructure.times.some(slot => slot.time === timeInput);
            if (exists) {
                showToast('×”×©×¢×” ×›×‘×¨ ×§×™×™××ª', 'danger');
                return;
            }
            
            const newSlot = {
                time: timeInput,
                type: 'free'
            };
            scheduleStructure.times.push(newSlot);
            
            scheduleStructure.times.sort((a, b) => a.time.localeCompare(b.time));
            
            renderStructureEditor();
            showToast(`×©×¢×” ${timeInput} × ×•×¡×¤×” ×‘×”×¦×œ×—×”`);
        }

        async function saveScheduleStructure() {
            if (!firebaseInitialized) {
                showToast('Firebase ×œ× ××•×’×“×¨ - ×œ× × ×™×ª×Ÿ ×œ×©××•×¨', 'danger');
                return;
            }

            try {
                await db.ref('scheduleStructure').set(scheduleStructure);
                showToast('××‘× ×” ×”×œ×•×– × ×©××¨ ×‘×”×¦×œ×—×”!');
                renderStudentSchedule();
            } catch (error) {
                console.error('Error saving structure:', error);
                showToast('×©×’×™××” ×‘×©××™×¨×”', 'danger');
            }
        }

        async function resetToDefaultStructure() {
            if (!confirm('×”×× ×œ××¤×¡ ××ª ××‘× ×” ×”×œ×•×– ×œ××¦×‘ ×‘×¨×™×¨×ª ×”××—×“×œ?')) return;

            scheduleStructure = JSON.parse(JSON.stringify(defaultScheduleStructure));
            
            if (firebaseInitialized) {
                try {
                    await db.ref('scheduleStructure').set(scheduleStructure);
                    showToast('××‘× ×” ×”×œ×•×– ××•×¤×¡!');
                } catch (error) {
                    console.error('Error resetting structure:', error);
                    showToast('×©×’×™××” ×‘××™×¤×•×¡', 'danger');
                }
            }
            
            renderStructureEditor();
            renderStudentSchedule();
        }

        // ==============================================
        // TOAST NOTIFICATIONS
        // ==============================================
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            
            toast.className = 'toast';
            
            if (type === 'danger') {
                toast.classList.add('danger');
            }
            
            setTimeout(() => {
                toast.classList.add('show');
            }, 10);
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 4000);
        }

        // ==============================================
        // EVENT LISTENERS
        // ==============================================
        document.getElementById('studentName').addEventListener('input', renderMySubmissions);
        document.getElementById('coordinatorWeekFilter').addEventListener('change', renderCoordinatorView);
        document.getElementById('coordinatorStatusFilter').addEventListener('change', renderCoordinatorView);
        document.getElementById('combinedWeekSelect').addEventListener('change', renderCombinedSchedule);

        // ==============================================
        // INITIALIZATION ON LOAD
        // ==============================================
        window.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>
